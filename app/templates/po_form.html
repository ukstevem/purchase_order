{% extends "base.html" %}

{% block title %}
  {{ 'Create PO' if mode == 'create' else 'Edit PO' }}
{% endblock %}

{% block content %}
<h2>{{ 'Create Purchase Order' if mode == 'create' else 'Edit Purchase Order'  }}
  {% if mode == 'edit' and po_data.po_number %}
    <span class="text-muted">{{ "%06d"|format(po_data.po_number) }}</span>
  {% endif %}
</h2>

<form method="POST" action="{{ form_action }}" id="po-form">
  <input type="hidden" name="idempotency_key" value="{{ idempotency_key }}">
  
  <!-- Project -->
  <label for="project_id">Project</label>
  <select name="project_id" required>
    {% for project in projects %}
      <option value="{{ project.id }}"
        {% if po_data.get('project_id') == project.id %} selected {% endif %}>
        {{ project.projectnumber }} - {{ project.projectdescription }}
      </option>
    {% endfor %}
  </select>

  <!-- Supplier -->
  <label for="supplier_id">Supplier</label>
  <select name="supplier_id" required>
    {% for supplier in suppliers %}
      <option value="{{ supplier.id }}"
        {% if po_data.get('supplier_id') == supplier.id %} selected {% endif %}>
        {{ supplier.name }}
      </option>
    {% endfor %}
  </select>

    <div class="form-group">
    <!-- Delivery Address (Controlled List Only) -->
    <label for="delivery_address_id">Deliver To</label>
    <select name="delivery_address_id" id="delivery_address_id" onchange="filterContacts()">
        <option value="">-- Select Address --</option>
        {% for address in delivery_addresses %}
            <option value="{{ address.id }}" 
                    {% if po_data.get('delivery_address_id') == address.id %}selected{% endif %}>
                {{ address.name }}
            </option>
        {% endfor %}
    </select>

    <!-- Delivery Contact (with Manual Option) -->
    <label for="delivery_contact_id">Delivery Contact</label>
    <select name="delivery_contact_id" id="delivery_contact_id" onchange="toggleManualContact()">
        <option value="">-- Select Contact --</option>
        {% for contact in delivery_contacts %}
            <option value="{{ contact.id }}" 
                    data-address-id="{{ contact.address_id }}"
                    {% if po_data.get('delivery_contact_id') == contact.id %}selected{% endif %}>
                {{ contact.name }}
            </option>
        {% endfor %}
        <option value="manual">⌨️ Enter Manual Contact</option>
    </select>

    <!-- Manual Contact Inputs (hidden by default) -->
    <div id="manual_contact_container" style="display: none; margin-top: 10px;">
      <div class="form-row">
        <div class="form-col">
          <label for="manual_contact_name">Contact Name</label>
          <input type="text" name="manual_contact_name" id="manual_contact_name"
                placeholder="Contact name..."
                value="{{ po_data.get('manual_contact_name', '') }}">
        </div>
        <div class="form-col">
          <label for="manual_contact_phone">Phone</label>
          <input type="tel" name="manual_contact_phone" id="manual_contact_phone"
                placeholder="Phone number..."
                value="{{ po_data.get('manual_contact_phone', '') }}">
        </div>
        <div class="form-col">
          <label for="manual_contact_email">Email</label>
          <input type="email" name="manual_contact_email" id="manual_contact_email"
                placeholder="Email address..."
                value="{{ po_data.get('manual_contact_email', '') }}">
        </div>
      </div>
    </div>

    <!-- Delivery Date + Terms + Test Certificates in one row -->
  <div class="form-row">

    <div class="form-col narrow">
      <label for="supplier_reference_number">Supplier Ref / Quote</label>
      <input type="text" name="supplier_reference_number" id="supplier_reference_number"
            placeholder="e.g. Q-12345"
            value="{{ po_data.get('supplier_reference_number', '') }}">
    </div>

    <div class="form-col narrow">
      <label for="delivery_date">Delivery Date</label>
      <input type="date" name="delivery_date" id="delivery_date"
            required value="{{ po_data.get('delivery_date', '') }}">
    </div>

    <div class="form-col">
      <label for="delivery_terms">Delivery Terms</label>
      <select id="delivery_terms" name="delivery_terms" required>
        <option value="">-- Select Incoterm --</option>
        <option value="EXW" {% if po_data.get('delivery_terms') == 'EXW' %}selected{% endif %}>EXW — Ex Works</option>
        <option value="FCA" {% if po_data.get('delivery_terms') == 'FCA' %}selected{% endif %}>FCA — Free Carrier</option>
        <option value="CPT" {% if po_data.get('delivery_terms') == 'CPT' %}selected{% endif %}>CPT — Carriage Paid To</option>
        <option value="CIP" {% if po_data.get('delivery_terms') == 'CIP' %}selected{% endif %}>CIP — Carriage and Insurance Paid To</option>
        <option value="DAP" {% if po_data.get('delivery_terms') == 'DAP' %}selected{% endif %}>DAP — Delivered At Place</option>
        <option value="DPU" {% if po_data.get('delivery_terms') == 'DPU' %}selected{% endif %}>DPU — Delivered at Place Unloaded</option>
        <option value="DDP" {% if po_data.get('delivery_terms') == 'DDP' %}selected{% endif %}>DDP — Delivered Duty Paid</option>
        <option value="FAS" {% if po_data.get('delivery_terms') == 'FAS' %}selected{% endif %}>FAS — Free Alongside Ship</option>
        <option value="FOB" {% if po_data.get('delivery_terms') == 'FOB' %}selected{% endif %}>FOB — Free On Board</option>
        <option value="CFR" {% if po_data.get('delivery_terms') == 'CFR' %}selected{% endif %}>CFR — Cost and Freight</option>
        <option value="CIF" {% if po_data.get('delivery_terms') == 'CIF' %}selected{% endif %}>CIF — Cost, Insurance & Freight</option>
      </select>
    </div>

    <div class="form-col narrow">
      <label for="test_cert_required">Test Certificates Required</label>
      <select name="test_cert_required" id="test_cert_required">
        <option value="0" {% if not po_data.get('test_cert_required') %}selected{% endif %}>No</option>
        <option value="1" {% if po_data.get('test_cert_required') %}selected{% endif %}>Yes</option>
      </select>
    </div>
  </div>


  <hr>

  <h3>Line Items</h3>

  <table class="line-items">
    <thead>
      <tr>
        <th>Description</th>
        <th style="width: 80px;">Qty</th>
        <th style="width: 80px;">Unit</th>
        <th style="width: 120px;">Unit Price</th>
        <th style="width: 130px;">Line Total</th>
        <th style="width: 80px;"></th>
      </tr>
    </thead>
    <tbody id="line-items-container">
      {% for item in po_data.get('line_items', [{}]) %}
        <tr>
          <td>
              <textarea name="description[]" 
                placeholder="Description" 
                required 
                rows="1">{{ item.get('description', '') }}</textarea>
          </td>
          <td><input type="number" name="quantity[]" value="{{ item.get('quantity', '') }}" placeholder="Qty" min="1" required oninput="updateTotal()"></td>
          <td><input type="text" name="unit[]" value="{{ item.get('unit', '') }}" placeholder="Unit" required></td>
          <td>
            <div class="money-input-wrap">
              <input type="text" name="unit_price[]"
                    value="{{ '{:,.2f}'.format(item.get('unit_price', 0)) if item.get('unit_price') else '' }}"
                    placeholder="Unit Price"
                    class="money-input"
                    oninput="formatMoneyInput(this); updateTotal()">
            </div>
          </td>
          <td class="money"><span class="currency">£</span><span class="row-total">0.00</span></td>
          <td class="actions">
            <button type="button" class="btn" onclick="removeLineItem(this)">Remove</button>
          </td>
        </tr>
      {% endfor %}
    </tbody>
    <tfoot>
      <tr>
        <td colspan="3"></td>
        <td class="total-label">Total:</td>
        <td class="total-value"><span class="currency">£</span><span id="po-total">0.00</span></td>
      </tr>
    </tfoot>
  </table>

  <br>

  <button type="button" class="btn" onclick="addLineItem()">+ Add Line Item</button>

<!-- Actions row -->
<div class="actions-bar">
  {% if mode == 'edit' and po_data.po_number %}
    <label for="status" class="actions-label">PO Status</label>
    <div class="actions-control">
      <select name="status" id="status">
        {% for s in statuses %}
          <option value="{{ s }}" {% if s == po_data.status %}selected{% endif %}>{{ s.title() }}</option>
        {% endfor %}
      </select>
    </div>
  {% endif %}

  {% if po_data.status == 'approved' %}
    <label for="bump_revision" class="actions-label">Bump Revision</label>
    <div class="actions-control">
      <select name="bump_revision" id="bump_revision">
        <option value="0" selected>No</option>
        <option value="1">Yes</option>
      </select>
    </div>
  {% endif %}

  <!-- Empty label cell keeps the grid aligned -->
  <span class="actions-label" aria-hidden="true"></span>
  <div class="actions-submit">
    <button type="submit" class="btn btn-compact" id="save-btn">
      {{ 'Create PO' if mode == 'create' else 'Save Changes' }}
    </button>
  </div>
</div>



</form>

<script>
/* -------------------- Line items (add/remove) -------------------- */
function addLineItem() {
  const container = document.getElementById('line-items-container');
  const row = document.createElement('tr');
  row.innerHTML = `
    <td><input type="text" name="description[]" placeholder="Description" required></td>
    <td><input type="number" name="quantity[]" placeholder="Qty" min="1" required oninput="updateTotal()"></td>
    <td><input type="text" name="unit[]" placeholder="Unit" required></td>
    <td>
      <div class="money-input-wrap">
        <input type="text" name="unit_price[]" placeholder="Unit Price" class="money-input">
      </div>
    </td>
    <td class="money"><span class="currency">£</span><span class="row-total">0.00</span></td>
    <td class="actions"><button type="button" class="btn" onclick="removeLineItem(this)">Remove</button></td>
  `;
  container.appendChild(row);
  wireMoneyInputs(row);   // <-- important: attach listeners to the new money input
  updateTotal();
}

function removeLineItem(button) {
  button.closest('tr').remove();
  updateTotal();
}

/* -------------------- Money input formatting -------------------- */
/* Parse "£1,234.56" or "1234.56" -> 1234.56 */
function parseMoney(str) {
  if (!str) return 0;
  const raw = String(str).replace(/[^0-9.]/g, "");
  const num = parseFloat(raw);
  return isNaN(num) ? 0 : num;
}

/* Format 1234.56 -> "1,234.56" (no currency symbol in inputs) */
function formatMoneyNumber(num) {
  return Number(num).toLocaleString("en-GB", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

/* On focus: show plain number (no commas) */
function moneyFocus(e) {
  const input = e.target;
  const raw = input.dataset.rawValue ?? parseMoney(input.value);
  input.value = raw ? String(raw) : "";
}

/* On input: update raw value; DO NOT reformat (preserves caret) */
function moneyInput(e) {
  const input = e.target;
  const raw = parseMoney(input.value);
  input.dataset.rawValue = raw;
  updateTotal();
}

/* On blur: format nicely with commas */
function moneyBlur(e) {
  const input = e.target;
  const raw = input.dataset.rawValue ?? parseMoney(input.value);
  input.dataset.rawValue = raw;
  input.value = raw ? formatMoneyNumber(raw) : "";
}

/* Attach money listeners to existing or newly-added rows */
function wireMoneyInputs(root = document) {
  root.querySelectorAll('input[name="unit_price[]"]').forEach(input => {
    if (input._moneyWired) return;
    input._moneyWired = true;
    input.addEventListener('focus', moneyFocus);
    input.addEventListener('input', moneyInput);
    input.addEventListener('blur', moneyBlur);

    // Initial normalisation: capture raw and show formatted
    const raw = parseMoney(input.value);
    input.dataset.rawValue = raw;
    input.value = raw ? formatMoneyNumber(raw) : "";
  });
}

// Before submit: replace formatted prices with raw numeric values
document.addEventListener('DOMContentLoaded', () => {
  const form = document.querySelector('form');
  if (!form) return;
  form.addEventListener('submit', () => {
    document.querySelectorAll('input[name="unit_price[]"]').forEach(input => {
      const raw = (input.dataset.rawValue != null)
        ? String(input.dataset.rawValue)
        : (input.value || '').replace(/[^0-9.]/g, '');
      input.value = raw; // ensure backend gets e.g. "11111.00"
    });
  });
});

/* -------------------- Totals -------------------- */
function updateTotal() {
  const rows = document.querySelectorAll('#line-items-container tr');
  let grand = 0;

  rows.forEach(row => {
    const qty = parseFloat(row.querySelector('input[name="quantity[]"]')?.value) || 0;

    const priceInput = row.querySelector('input[name="unit_price[]"]');
    const price = priceInput?.dataset.rawValue
      ? parseFloat(priceInput.dataset.rawValue)
      : parseMoney(priceInput?.value);

    const line = qty * (isNaN(price) ? 0 : price);

    const cell = row.querySelector('.row-total');
    if (cell) cell.textContent = formatMoneyNumber(line);

    grand += line;
  });

  const totalSpan = document.getElementById('po-total');
  if (totalSpan) totalSpan.textContent = formatMoneyNumber(grand);
}

/* -------------------- Manual contact helpers -------------------- */
function setManualInputsEnabled(enabled) {
  const manualContainer = document.getElementById('manual_contact_container');
  const nameInput = document.getElementById('manual_contact_name');
  const phoneInput = document.getElementById('manual_contact_phone');
  const emailInput = document.getElementById('manual_contact_email');

  manualContainer.style.display = enabled ? 'block' : 'none';
  nameInput.disabled = !enabled;
  phoneInput.disabled = !enabled;
  emailInput.disabled = !enabled;
  nameInput.required = !!enabled;
}
function clearManualInputs() {
  document.getElementById('manual_contact_name').value = "";
  document.getElementById('manual_contact_phone').value = "";
  document.getElementById('manual_contact_email').value = "";
}
function toggleManualContact() {
  const contactSelect = document.getElementById('delivery_contact_id');
  const isManual = contactSelect.value === 'manual';
  clearManualInputs();
  setManualInputsEnabled(isManual);
}

/* -------------------- Address → contact filtering -------------------- */
function filterContacts() {
  const selectedAddressId = document.getElementById('delivery_address_id').value;
  const contactSelect = document.getElementById('delivery_contact_id');
  const options = contactSelect.options;

  contactSelect.disabled = !selectedAddressId;

  let currentSelectionValid = false;
  const currentValue = contactSelect.value;

  for (let i = 0; i < options.length; i++) {
    const option = options[i];
    const optionAddressId = option.getAttribute('data-address-id');

    if (i === 0 || option.value === 'manual') {
      option.hidden = false;
      continue;
    }
    if (optionAddressId === selectedAddressId) {
      option.hidden = false;
      if (option.value === currentValue) currentSelectionValid = true;
    } else {
      option.hidden = true;
    }
  }

  if (!currentSelectionValid && currentValue !== '' && currentValue !== 'manual') {
    contactSelect.value = '';
  }
}

/* -------------------- Init -------------------- */
window.addEventListener("DOMContentLoaded", function () {
  // Money inputs + totals
  wireMoneyInputs(document);
  updateTotal();

  // Manual contact init
  const contactSelect = document.getElementById('delivery_contact_id');
  const manualContactNameEl = document.getElementById('manual_contact_name');
  const manualContactName = manualContactNameEl ? manualContactNameEl.value.trim() : "";

  if (manualContactName && !contactSelect.value) {
    contactSelect.value = 'manual';
  }

  toggleManualContact();
  filterContacts();
});

/* -------------------- Disable save button on press -------------------- */

  (function () {
    const form = document.getElementById('po-form');
    const btn  = document.getElementById('save-btn');
    let submitted = false;
    form.addEventListener('submit', function (e) {
      if (submitted) { e.preventDefault(); return; }
      submitted = true;
      btn.disabled = true;
      btn.textContent = 'Saving…';
    });
  })();


</script>

{% endblock %}
