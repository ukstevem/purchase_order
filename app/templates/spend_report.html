{% extends "base.html" %}

{% block title %}Spend Report{% endblock %}

{% block content %}
<h2>Purchase Order spend per project (Rolling 12 Months)</h2>

<div class="table-wrap">
  <table class="table table-striped pivot compact">
    <colgroup>
      <col style="width: 8ch;">           <!-- Project -->
      {% for m in months %}<col style="width: 9ch;">{% endfor %}  <!-- Months -->
      <col style="width: 11ch;">          <!-- Total -->
    </colgroup>

    <thead>
      <tr>
        <th class="sticky-left">Project</th>
        {% for m in months %}
          <th class="num">{{ m | format_date("%b %Y") }}</th>
        {% endfor %}
        <th class="num sticky-right">Total</th>
      </tr>
    </thead>

    <tbody>
      {% for project in project_order %}
        {% set spends = data[project] %}
        <tr>
          <td class="sticky-left proj">{{ project }}</td>

          {% for m in months %}
            {% set val = (spends.get(m, 0) or 0) %}
            <td class="num">
              {% if val %}
              <a class="drill-link"
                href="{{ url_for('main.po_list',
                                  project=project,                              
                                  **{'from': month_from[m], 'to': month_to[m]}) }}"
                title="Show POs for {{ project }} in {{ m | format_date('%B %Y') }}">
                {{ val | accounting }}
              </a>
              {% else %}
                {{ val | accounting }}
              {% endif %}
            </td>
          {% endfor %}

          {# Optional: link the row total to project-only filter #}
          <td class="num sticky-right total">
            {% set row_total = (row_totals[project] or 0) %}
            {% if row_total %}
            <a class="drill-link"
              href="{{ url_for('main.po_list', project=project) }}"
              title="Show all POs for {{ project }}">
              {{ row_total | accounting }}
            </a>
            {% else %}
              {{ row_total | accounting }}
            {% endif %}
          </td>
        </tr>
      {% endfor %}

      <tr class="grand">
        <td class="sticky-left">Total</td>

        {# Optional: link column totals to month-only filter across all projects #}
        {% for m in months %}
          {% set ctot = (col_totals[m] or 0) %}
          <td class="num">
            {% if ctot %}
              <a class="drill-link"
                 href="{{ url_for('main.po_list', **{'from': month_from[m], 'to': month_to[m]}) }}"
                 title="Show all POs in {{ m | format_date('%B %Y') }}">
                {{ ctot | accounting }}
              </a>
            {% else %}
              {{ ctot | accounting }}
            {% endif %}
          </td>
        {% endfor %}

        <td class="num sticky-right total">{{ (grand_total or 0) | accounting }}</td>
      </tr>
    </tbody>
  </table>
</div>

<style>
  /* wrapper enables horizontal scroll when needed */
  .table-wrap {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    border: 1px solid #ddd;
    border-radius: 8px;
    background: #fff;
  }

  /* let the table be as wide as it needs; no forced squish */
  table.pivot { width: max-content; min-width: 100%; border-collapse: separate; border-spacing: 0; }

  /* compact spacing for numeric matrix */
  table.pivot.compact th,
  table.pivot.compact td { padding: 6px 10px; font-size: 0.92rem; }

  /* right-aligned numeric cells */
  .num { text-align: right; white-space: nowrap; font-variant-numeric: tabular-nums; }

  /* sticky edges */
  .sticky-left,
  .sticky-right,
  thead th { position: sticky; z-index: 2; background: #fff; }

  thead th { top: 0; box-shadow: inset 0 -1px 0 #e6e6e6; }

  .sticky-left { left: 0; z-index: 3; box-shadow: 1px 0 0 #eee; }
  .sticky-right { right: 0; z-index: 3; box-shadow: -1px 0 0 #eee; }

  /* subtle emphasis for totals */
  td.total { font-weight: 600; }
  tr.grand td { font-weight: 700; border-top: 2px solid #000; }

  /* keep long project names readable without blowing up row height */
  td.proj { white-space: nowrap; text-overflow: ellipsis; overflow: hidden; max-width: 32ch; }

  /* --- toned-down link style for spend values --- */
  .table.pivot .num a.drill-link {
    color: inherit;                 /* no bright blue */
    text-decoration: none;          /* remove underline */
    border-bottom: 1px dotted transparent; /* subtle affordance on hover/focus only */
    padding-bottom: 1px;
  }
  .table.pivot .num a.drill-link:hover,
  .table.pivot .num a.drill-link:focus {
    border-bottom-color: currentColor;
  }
  .table.pivot .num a.drill-link:visited {
    color: inherit;
  }
  .table.pivot .num a.drill-link:focus-visible {
    outline: 2px solid rgba(0, 0, 0, 0.25);
    outline-offset: 2px;
    border-radius: 2px;
  }
</style>
{% endblock %}
