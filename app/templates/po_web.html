{% extends "base.html" %}
{% block title %}PO Preview{% endblock %}
{% block content %}

<style>
  .btn-email-po {
    background-color: #8b0000; /* dark red */
    color: #ffffff;
  }
  .btn-email-po:hover {
    background-color: #a00000;
  }

  .btn-view-po {
    background-color: #006400; /* dark green */
    color: #ffffff;
  }
  .btn-view-po:hover {
    background-color: #008000;
  }
</style>


{# --- Macro for accounting-style money cells: £ left, number right, negatives in parentheses --- #}
{% macro money_cell(value) -%}
  {% set v = (value if value is not none else 0) %}
  {% if v < 0 %}
    <span style="float:left;">(£</span>
    <span style="float:right;">{{ "{:,.2f}".format(v|abs) }})</span>
  {% else %}
    <span style="float:left;">£</span>
    <span style="float:right;">{{ "{:,.2f}".format(v) }}</span>
  {% endif %}
{%- endmacro %}

<div class="noprint" style="margin-bottom: 1em; display: flex; gap: 0.5rem;">
  <a href="{{ url_for('main.po_pdf', po_id=po['id']) }}" class="btn btn-email-po" target="_blank">Issue PO</a>
  <a href="{{ url_for('main.po_view_pdf', po_id=po['id']) }}" class="btn btn-view-po" target="_blank">View PDF</a>
</div>

<div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1em;">
  {% if logo_base64 %}
    <img src="data:image/png;base64,{{ logo_base64 }}" alt="Logo" style="height: 150px;">
  {% else %}
    <img src="{{ url_for('static', filename='img/PSS_Standard_RGB.png') }}" alt="Logo" style="height: 200px;">
  {% endif %}

  <div style="text-align: right;">
    <h2 style="margin: 0;">Purchase Order</h2>
    <p style="margin: 0;">
      <strong>PO Number:</strong>
      {% set pn = po.get('po_number') %}
      {% set projnum = po.get('projectnumber') or po.get('project_id') %}
      {% if pn is not none and (pn|string).isdigit() -%}
        {{ "%06d"|format(pn|int) -}}
      {%- else -%}
        {{ pn or "" -}}
      {%- endif -%}
      {%- if projnum %}-{{ projnum }}{% endif %}
    </p>
    <p style="margin: 0;"><strong>PO Date:</strong> {{ po.get('updated_at')|format_date }}</p>
    <p style="margin: 0;"><strong>Revision:</strong> {{ po.get('current_revision', '-') }}</p>
  </div>
</div>
<hr style="margin: 1em 0;">

{% if po and po.get('id') %}

<div style="display: flex; justify-content: space-between; margin-top: 1em; gap: 2em;">

  {# Prepare handy locals #}
  {% set md = po.get('po_metadata') or {} %}
  {% set sup = po.get('suppliers') or {} %}
  {% set daddr = po.get('delivery_address') or {} %}
  {% set dcont = po.get('delivery_contact') or delivery_contact or {} %}

  <!-- Supplier -->
  <div style="flex: 1;">
    <p style="margin: 0;">
      <strong>Supplier:</strong><br>

      {% if sup.get('name') %}{{ sup.get('name')|default('', true) }}<br>{% endif %}
      {% if sup.get('address_line1') %}{{ sup.get('address_line1')|default('', true) }}<br>{% endif %}
      {% if sup.get('address_line2') %}{{ sup.get('address_line2')|default('', true) }}<br>{% endif %}
      {% if sup.get('postcode') %}{{ sup.get('postcode')|default('', true) }}<br>{% endif %}
    </p>

    <p style="margin: .5em 0 0 0;">
      {% if md.get('supplier_reference_number') %}
            <strong>Ref:</strong> {{ md.get('supplier_reference_number') }}<br>
      {% endif %}
  
      {% if md.get('delivery_date') %}    
            <strong>Delivery Date:</strong> {{ md.get('delivery_date')|format_date }}<br>
      {% endif %}

      {% if md.get('delivery_terms') %}
            <strong>Delivery Terms:</strong> {{ md.get('delivery_terms')|default('', true) }}
      {% endif %}
    </p>

  </div>

  <!-- Delivery -->
  <div style="flex: 1; display: flex; justify-content: flex-end;">
    <div style="text-align: left;">
      <p style="margin: 0;">
        <strong>Delivery Address:</strong><br>

        {# Manual address takes priority #}
        {% if po.get('manual_delivery_address') %}
          <pre style="text-align: left; display: inline-block; margin: 0;">
            {{ po.get('manual_delivery_address')|default('', true) }}
          </pre>

        {# Otherwise use structured fields, printing only non-empty lines #}
        {% elif daddr %}
          {% if daddr.get('name') %}{{ daddr.get('name')|default('', true) }}<br>{% endif %}
          {% if daddr.get('address_line1') %}{{ daddr.get('address_line1')|default('', true) }}<br>{% endif %}
          {% if daddr.get('address_line2') %}{{ daddr.get('address_line2')|default('', true) }}<br>{% endif %}
          {% if daddr.get('postcode') %}{{ daddr.get('postcode')|default('', true) }}{% endif %}
        {% else %}
          —
        {% endif %}
      </p>

      {# Delivery Contact AFTER the address #}
      {% if dcont.get('name') or dcont.get('phone') or dcont.get('email')
            or md.get('manual_contact_name') or md.get('manual_contact_phone') or md.get('manual_contact_email') %}
        <p style="margin: .5em 0 0 0;">
          {% set cname = dcont.get('name') or md.get('manual_contact_name') %}
          {% set cphone = dcont.get('phone') or md.get('manual_contact_phone') %}
          {% set cemail = dcont.get('email') or md.get('manual_contact_email') %}

          {% if cname %}<strong>Contact:</strong> {{ cname|default('', true) }}<br>{% endif %}
          {% if cphone %}<strong>Phone:</strong> {{ cphone|default('', true) }}<br>{% endif %}
          {% if cemail %}<strong>Email:</strong> {{ cemail|default('', true) }}{% endif %}
        </p>
      {% endif %}
    </div>
  </div>

</div>

<hr>

{% if po.get('line_items') %}
<table class="po-web-items">
  <thead>
    <tr>
      <th class="col-idx" style="width:5%;">Line</th>
      <th class="col-desc" style="width:auto;">Description</th>
      <th class="col-qty" style="width:10%;">Qty</th>
      <th class="col-unit" style="width:10%;">Unit</th>
      <th class="col-price num" style="width:15%;">Unit Price</th>
      <th class="col-total num" style="width:15%;">Total</th>
    </tr>
  </thead>

  {# running total for all line items #}
  {% set totals = namespace(grand_total=0) %}

  <tbody>
    {% for item in po['line_items'] %}
      {% set qty = item.get('quantity') or 0 %}
      {% set unit_price = item.get('unit_price') or 0 %}
      {% set line_total = item.get('total') if item.get('total') is not none else (qty * unit_price) %}
      {% set totals.grand_total = totals.grand_total + line_total %}

      {# expediting status set in po_preview: 'late', 'delivered', 'partial', or 'none' #}
      {% set status = item.get('exped_status', 'none') %}

      <tr class="po-row-{{ status }}">
        <td class="col-idx center">{{ loop.index }}</td>
        <td class="col-desc">{{ item.get('description', '') | nl2br }}</td>
        <td class="num">{{ "{:,.2f}".format(qty) }}</td>
        <td class="col-unit">{{ item.get('unit')|default('', true) }}</td>
        <td class="col-price num">{{ money_cell(unit_price) }}</td>
        <td class="col-total num">{{ money_cell(line_total) }}</td>
      </tr>
    {% endfor %}
  </tbody>



  <tfoot>
    <tr>
      <td colspan="5" class="num" style="text-align: right;"><strong>Total Value</strong></td>
      <td class="col-total num"><strong>{{ money_cell(totals.grand_total) }}</strong></td>
    </tr>
  </tfoot>
</table>

{% else %}
  <p>No line items available.</p>
{% endif %}

<br>

<div class="noprint" style="margin-bottom: 1em; display: flex; justify-content: space-between; align-items: center;">
  <a href="{{ url_for('main.edit_po', po_id=po['id']) }}" class="btn">✏️ Edit</a>
  <div style="display: inline-flex; gap: 0.5rem;">
    <a href="{{ url_for('main.po_pdf', po_id=po['id']) }}" class="btn btn-email-po" target="_blank">Issue PO</a>
    <a href="{{ url_for('main.po_view_pdf', po_id=po['id']) }}" class="btn btn-view-po" target="_blank">View PDF</a>
  </div>
</div>

{% else %}
  <p>PO not found.</p>
{% endif %}
{% endblock %}
